FROM registry.access.redhat.com/ubi9/python-311:latest

# Fix CVE-2025-14087 (glib2) + CVE-2024-6345/CVE-2025-47273 (setuptools)
USER 0
RUN dnf upgrade -y glib2 && \
    rpm -e --nodeps python3-setuptools python3-setuptools-wheel 2>/dev/null || true && \
    dnf clean all
USER 1001

WORKDIR /opt/app
COPY app/requirements.txt /opt/app/
RUN pip install --no-cache-dir "setuptools>=78.1.1" && \
    pip install --no-cache-dir -r requirements.txt

COPY app/ /opt/app/

ENV PORT=8080
EXPOSE 8080

# UBI python já roda como usuário não-root
CMD ["python", "main.py"]
